models:
  - name: dim_accounts
    description: |
      Dimension table for accounts with institution context.
      Joins accounts with connections and institutions to provide full context for analytics.
    meta:
      dataset: true
      friendly_name: "Accounts"
      group: "dimensions"
      filters:
        account_id_column: "account_id"
      semantic:
        measures:
          - name: account_count
            expr: "account_id"
            agg: count
            description: "Number of accounts"
        dimensions:
          - name: account_type
            expr: "account_type"
            type: categorical
            description: "Type of account (bank, investment, trading)"
          - name: category
            expr: "category"
            type: categorical
            description: "Account category (credit_card, bank_account, etc.)"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Primary currency of the account"
          - name: provider
            expr: "provider"
            type: categorical
            description: "Data provider (gocardless, trading212, vanguard)"
          - name: connection_status
            expr: "connection_status"
            type: categorical
            description: "Status of the bank connection"
        sample_questions:
          - "How many accounts do I have?"
          - "How many accounts do I have by type?"
          - "What providers are my accounts connected through?"
    columns:
      - name: account_id
        description: Unique identifier for the account (UUID)
        data_tests:
          - not_null
          - unique
      - name: user_id
        description: Owner of the account (UUID)
        data_tests:
          - not_null
      - name: display_name
        description: User-friendly account name
        data_tests:
          - not_null
      - name: currency
        description: Primary currency of the account (ISO 4217)
      - name: account_type
        description: Type of account (bank, investment, trading)
        data_tests:
          - not_null
      - name: category
        description: User-defined category (credit_card, bank_account, etc.)
      - name: credit_limit
        description: Credit limit for credit cards
      - name: account_status
        description: Current status of the account (active, inactive)
        data_tests:
          - not_null
      - name: raw_balance_amount
        description: Raw balance as reported by the bank (before normalization)
      - name: balance_amount
        description: Normalized balance (for credit cards, always represents amount owed)
      - name: balance_currency
        description: Currency of the balance
      - name: balance_type
        description: Type of balance (expected, booked, etc.)
      - name: balance_updated_at
        description: When the balance was last updated
      - name: total_value
        description: Total value for investment accounts
      - name: unrealised_pnl
        description: Unrealised profit/loss for investment accounts
      - name: provider_id
        description: Provider-specific account identifier (for joining with provider tables)
        data_tests:
          - not_null
      - name: connection_id
        description: ID of the parent connection
        data_tests:
          - not_null
      - name: connection_name
        description: Friendly name of the connection
      - name: provider
        description: Data provider (gocardless, trading212, vanguard)
        data_tests:
          - not_null
      - name: connection_status
        description: Status of the connection
      - name: connection_expires_at
        description: When the connection expires (if applicable)
      - name: institution_id
        description: ID of the financial institution
        data_tests:
          - not_null
      - name: institution_name
        description: Name of the financial institution
      - name: institution_logo_url
        description: URL to the institution's logo

  - name: dim_tags
    description: |
      Dimension table for user-defined tags.
      Provides tag metadata for analytics joins.
    meta:
      dataset: true
      friendly_name: "Tags"
      group: "dimensions"
      filters:
        tag_id_column: "tag_id"
      semantic:
        measures:
          - name: tag_count
            expr: "tag_id"
            agg: count
            description: "Number of tags"
        dimensions:
          - name: name
            expr: "name"
            type: categorical
            description: "Tag name"
        sample_questions:
          - "How many tags do I have?"
          - "What are my tag names?"
    columns:
      - name: tag_id
        description: Unique identifier for the tag (UUID)
        data_tests:
          - not_null
          - unique
      - name: user_id
        description: Owner of the tag (UUID)
        data_tests:
          - not_null
      - name: name
        description: Tag name
        data_tests:
          - not_null
      - name: colour
        description: Hex colour code for the tag
      - name: created_at
        description: When the tag was created

  - name: fct_transactions
    description: |
      Fact table for transactions with tags denormalized.
      Base transaction data enriched with account and tag context for analytics.
    meta:
      dataset: true
      friendly_name: "Transactions"
      group: "facts"
      filters:
        date_column: "booking_date"
        account_id_column: "account_id"
      semantic:
        measures:
          - name: amount
            expr: "amount"
            agg: sum
            description: "Total transaction amount (positive for income, negative for spending)"
          - name: spending_amount
            expr: "spending_amount"
            agg: sum
            description: "Total spending amount"
          - name: income_amount
            expr: "income_amount"
            agg: sum
            description: "Total income amount"
          - name: transaction_count
            expr: "transaction_id"
            agg: count
            description: "Number of transactions"
        dimensions:
          - name: booking_date
            expr: "booking_date"
            type: time
            description: "Date the transaction was booked"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Transaction currency"
          - name: counterparty_name
            expr: "counterparty_name"
            type: categorical
            description: "Merchant or sender name"
          - name: category
            expr: "category"
            type: categorical
            description: "Transaction category"
          - name: account_name
            expr: "account_name"
            type: categorical
            description: "Name of the account"
          - name: institution_name
            expr: "institution_name"
            type: categorical
            description: "Name of the financial institution"
        sample_questions:
          - "How much did I spend last month?"
          - "What are my top spending categories?"
          - "How much income did I receive this year?"
          - "What merchants do I spend the most at?"
    columns:
      - name: transaction_id
        description: Unique identifier for the transaction (UUID)
        data_tests:
          - not_null
          - unique
      - name: account_id
        description: Account the transaction belongs to (UUID)
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the account (UUID)
        data_tests:
          - not_null
      - name: booking_date
        description: Date the transaction was booked
      - name: value_date
        description: Value date of the transaction
      - name: amount
        description: Transaction amount (positive for income, negative for spending)
        data_tests:
          - not_null
      - name: currency
        description: Currency of the transaction
        data_tests:
          - not_null
      - name: counterparty_name
        description: Name of the counterparty (merchant/sender)
      - name: description
        description: Transaction description
      - name: category
        description: Transaction category
      - name: tags
        description: List of tags applied to this transaction
      - name: account_name
        description: Name of the account
      - name: institution_name
        description: Name of the financial institution
      - name: spending_amount
        description: Spending amount (positive) or 0
      - name: income_amount
        description: Income amount (positive) or 0
      - name: synced_at
        description: When the transaction was last synced

  - name: fct_daily_spending_by_tag
    description: |
      Pre-aggregated daily spending by tag.
      Aggregates transaction amounts by date and tag for efficient trend analysis.
    meta:
      dataset: true
      friendly_name: "Daily Spending by Tag"
      group: "aggregations"
      time_grain: "day"
      filters:
        date_column: "spending_date"
        tag_id_column: "tag_id"
      semantic:
        measures:
          - name: total_spending
            expr: "total_spending"
            agg: sum
            description: "Total spending amount"
          - name: transaction_count
            expr: "transaction_count"
            agg: sum
            description: "Number of transactions"
        dimensions:
          - name: spending_date
            expr: "spending_date"
            type: time
            description: "Date of the spending"
          - name: tag_name
            expr: "tag_name"
            type: categorical
            description: "Tag name"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency of the spending"
        sample_questions:
          - "How much did I spend on groceries last month?"
          - "What is my daily spending trend by tag?"
          - "Which tags have the highest spending?"
    columns:
      - name: spending_date
        description: Date of the spending
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the transactions (UUID)
        data_tests:
          - not_null
      - name: tag_id
        description: Tag applied to the transactions (UUID, null for untagged)
      - name: tag_name
        description: Name of the tag ("Untagged" for transactions without tags)
        data_tests:
          - not_null
      - name: tag_colour
        description: Hex colour code for the tag
      - name: currency
        description: Currency of the spending
        data_tests:
          - not_null
      - name: total_spending
        description: Total spending amount for this tag on this date
        data_tests:
          - not_null
      - name: transaction_count
        description: Number of transactions
        data_tests:
          - not_null

  - name: int_recurring_candidates
    description: |
      Intermediate model for recurring pattern detection.
      Analyses transaction history to identify candidate recurring payments.
    meta:
      dataset: false
      group: "intermediate"
    columns:
      - name: account_id
        description: Account the transactions belong to
      - name: user_id
        description: Owner of the account
      - name: merchant_key
        description: Normalised merchant name (lowercase, trimmed)
      - name: currency
        description: Currency of the transactions
      - name: occurrence_count
        description: Number of matching transactions
      - name: avg_amount
        description: Average transaction amount
      - name: avg_interval
        description: Average days between transactions
      - name: last_occurrence
        description: Most recent transaction date
      - name: detected_frequency
        description: Detected payment frequency (weekly, monthly, etc.)
      - name: confidence_score
        description: Pattern detection confidence (0.0-1.0)

  - name: fct_recurring_patterns
    description: |
      Fact table for recurring payment patterns (subscriptions, bills, income).
      Merges auto-detected patterns with user-managed patterns from the database.
      Supports both expense patterns (subscriptions) and income patterns (salary, transfers).
    meta:
      dataset: true
      friendly_name: "Recurring Patterns"
      group: "facts"
      filters:
        date_column: "next_expected_date"
      semantic:
        measures:
          - name: expected_amount
            expr: "expected_amount"
            agg: sum
            description: "Total expected recurring amount"
          - name: monthly_equivalent
            expr: "monthly_equivalent"
            agg: sum
            description: "Total monthly equivalent amount"
          - name: match_count
            expr: "match_count"
            agg: sum
            description: "Total matched transactions"
        dimensions:
          - name: frequency
            expr: "frequency"
            type: categorical
            description: "Payment frequency (weekly, monthly, etc.)"
          - name: direction
            expr: "direction"
            type: categorical
            description: "Direction of flow (expense or income)"
          - name: status
            expr: "status"
            type: categorical
            description: "Pattern status (pending, active, paused, cancelled)"
          - name: source
            expr: "source"
            type: categorical
            description: "How the pattern was created (detected or manual)"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency of the amount"
          - name: next_expected_date
            expr: "next_expected_date"
            type: time
            description: "Next expected payment date"
        sample_questions:
          - "What are my active subscriptions?"
          - "How much do I spend on recurring payments monthly?"
          - "What recurring income do I have?"
    columns:
      - name: pattern_id
        description: Unique identifier for the pattern
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the pattern
        data_tests:
          - not_null
      - name: account_id
        description: Associated account (optional)
      - name: name
        description: User-friendly display name for the pattern
        data_tests:
          - not_null
      - name: notes
        description: User notes about this pattern
      - name: expected_amount
        description: Expected transaction amount
        data_tests:
          - not_null
      - name: currency
        description: Currency of the amount
        data_tests:
          - not_null
      - name: frequency
        description: Payment frequency (weekly, monthly, etc.)
        data_tests:
          - not_null
      - name: direction
        description: Direction of flow (expense or income)
        data_tests:
          - not_null
          - accepted_values:
              values: ['expense', 'income']
      - name: status
        description: Pattern status (pending, active, paused, cancelled)
        data_tests:
          - not_null
          - accepted_values:
              values: ['pending', 'active', 'paused', 'cancelled']
      - name: source
        description: How the pattern was created (detected or manual)
        data_tests:
          - not_null
          - accepted_values:
              values: ['detected', 'manual']
      - name: merchant_contains
        description: Text to match in merchant name (case-insensitive)
      - name: amount_tolerance_pct
        description: Allowed percentage deviation from expected amount
        data_tests:
          - not_null
      - name: confidence_score
        description: Detection confidence (0.0-1.0), null for manual patterns
      - name: occurrence_count
        description: Number of occurrences found during detection
      - name: match_count
        description: Number of transactions linked to this pattern
        data_tests:
          - not_null
      - name: detection_reason
        description: Human-readable explanation of why pattern was detected
      - name: anchor_date
        description: Reference date for scheduling calculations
      - name: last_matched_date
        description: Most recent matching transaction date
      - name: end_date
        description: When the pattern ended (for cancelled patterns)
      - name: next_expected_date
        description: Calculated next expected payment date
      - name: monthly_equivalent
        description: Amount converted to monthly equivalent
      - name: is_overdue
        description: Whether the pattern is past expected date + grace period
      - name: days_until_next
        description: Days until next expected payment
      - name: created_at
        description: When the pattern was created
      - name: updated_at
        description: When the pattern was last updated

  - name: fct_daily_balance_history
    description: |
      Daily balance history per account.
      Aggregates balance snapshots to daily grain with gap-filling for continuous time series.
      Includes daily change calculations for trend analysis.
    meta:
      dataset: true
      friendly_name: "Daily Balance History"
      group: "aggregations"
      time_grain: "day"
      filters:
        date_column: "balance_date"
        account_id_column: "account_id"
      semantic:
        measures:
          - name: balance_amount
            expr: "balance_amount"
            agg: max
            description: "Balance amount (latest snapshot)"
          - name: daily_change
            expr: "daily_change"
            agg: sum
            description: "Total daily balance change"
          - name: total_value
            expr: "total_value"
            agg: max
            description: "Total value for investment accounts (latest snapshot)"
        dimensions:
          - name: balance_date
            expr: "balance_date"
            type: time
            description: "Date of the balance snapshot"
          - name: account_name
            expr: "account_name"
            type: categorical
            description: "Display name of the account"
          - name: account_type
            expr: "account_type"
            type: categorical
            description: "Type of account (bank, investment, trading)"
          - name: balance_currency
            expr: "balance_currency"
            type: categorical
            description: "Currency of the balance"
        sample_questions:
          - "What is my balance trend over the last 3 months?"
          - "Which account has the highest balance?"
          - "How has my balance changed by account type?"
    columns:
      - name: account_id
        description: Unique identifier for the account (UUID)
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the account (UUID)
        data_tests:
          - not_null
      - name: account_name
        description: Display name of the account
        data_tests:
          - not_null
      - name: account_type
        description: Type of account (bank, investment, trading)
        data_tests:
          - not_null
      - name: balance_date
        description: Date of the balance snapshot
        data_tests:
          - not_null
      - name: balance_amount
        description: Balance amount (forward-filled for gaps). Credit card balances are negative (liabilities).
        data_tests:
          - not_null
      - name: balance_currency
        description: Currency of the balance
        data_tests:
          - not_null
      - name: balance_type
        description: Type of balance (expected, booked, etc.)
      - name: total_value
        description: Total value for investment accounts
      - name: unrealised_pnl
        description: Unrealised profit/loss for investment accounts
      - name: daily_change
        description: Change in balance from previous day
        data_tests:
          - not_null
      - name: daily_value_change
        description: Change in total value from previous day
        data_tests:
          - not_null
      - name: is_actual_snapshot
        description: Whether this is an actual snapshot (true) or gap-filled (false)
        data_tests:
          - not_null

  - name: fct_net_worth_history
    description: |
      Net worth history per user per day.
      Sums all account balances to calculate total net worth over time.
      Includes daily change, 7-day rolling average, and month comparison metrics.
    meta:
      dataset: true
      friendly_name: "Net Worth History"
      group: "aggregations"
      time_grain: "day"
      filters:
        date_column: "balance_date"
      semantic:
        measures:
          - name: net_worth
            expr: "net_worth"
            agg: max
            description: "Total net worth (latest snapshot)"
          - name: total_cash_balance
            expr: "total_cash_balance"
            agg: max
            description: "Total cash balance (latest snapshot)"
          - name: total_investment_value
            expr: "total_investment_value"
            agg: max
            description: "Total investment value (latest snapshot)"
          - name: daily_change
            expr: "daily_change"
            agg: sum
            description: "Total daily change in net worth"
        dimensions:
          - name: balance_date
            expr: "balance_date"
            type: time
            description: "Date of the net worth snapshot"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Primary currency"
        sample_questions:
          - "What is my current net worth?"
          - "How has my net worth changed over the last year?"
          - "What is my net worth trend by month?"
    columns:
      - name: user_id
        description: Owner of the accounts (UUID)
        data_tests:
          - not_null
      - name: balance_date
        description: Date of the net worth snapshot
        data_tests:
          - not_null
      - name: currency
        description: Primary currency (ISO 4217)
        data_tests:
          - not_null
      - name: net_worth
        description: Total net worth (sum of all account values)
        data_tests:
          - not_null
      - name: total_cash_balance
        description: Sum of cash balances across all accounts
      - name: total_investment_value
        description: Sum of investment portfolio values
      - name: account_count
        description: Number of accounts included
        data_tests:
          - not_null
      - name: is_actual_snapshot
        description: Whether all accounts have actual snapshots (not gap-filled)
        data_tests:
          - not_null
      - name: daily_change
        description: Change in net worth from previous day
        data_tests:
          - not_null
      - name: rolling_7d_avg
        description: 7-day rolling average of net worth
      - name: month_start
        description: First day of the month for this date
      - name: month_start_net_worth
        description: Net worth at the start of the month
      - name: change_from_month_start
        description: Change in net worth since month start
      - name: pct_change_from_month_start
        description: Percentage change since month start

  - name: fct_monthly_trends
    description: |
      Monthly income, spending, and net trends per user.
      Aggregates transaction data by month for high-level financial overview.
    meta:
      dataset: true
      friendly_name: "Monthly Trends"
      group: "aggregations"
      time_grain: "month"
      filters:
        date_column: "month_start"
      semantic:
        measures:
          - name: total_income
            expr: "total_income"
            agg: sum
            description: "Total income for the period"
          - name: total_spending
            expr: "total_spending"
            agg: sum
            description: "Total spending for the period"
          - name: net_change
            expr: "net_change"
            agg: sum
            description: "Net change (income - spending)"
          - name: savings_rate_pct
            expr: "savings_rate_pct"
            agg: avg
            description: "Average savings rate percentage"
          - name: total_transactions
            expr: "total_transactions"
            agg: sum
            description: "Total number of transactions"
        dimensions:
          - name: month_start
            expr: "month_start"
            type: time
            description: "First day of the month"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency of the amounts"
        sample_questions:
          - "What is my income vs spending trend?"
          - "What is my average savings rate?"
          - "Which month did I spend the most?"
          - "How much did I save last quarter?"
    columns:
      - name: month_start
        description: First day of the month
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the transactions (UUID)
        data_tests:
          - not_null
      - name: currency
        description: Currency of the amounts
        data_tests:
          - not_null
      - name: total_income
        description: Total income for the month
        data_tests:
          - not_null
      - name: total_spending
        description: Total spending for the month
        data_tests:
          - not_null
      - name: net_change
        description: Net change (income - spending)
        data_tests:
          - not_null
      - name: savings_rate_pct
        description: Percentage of income saved
      - name: total_transactions
        description: Total number of transactions
        data_tests:
          - not_null
      - name: income_transactions
        description: Number of income transactions
        data_tests:
          - not_null
      - name: spending_transactions
        description: Number of spending transactions
        data_tests:
          - not_null

  - name: fct_spending_pace
    description: |
      Spending pace comparison for the current month.
      Compares actual spending against a 90-day historical daily average to show
      whether the user is spending faster or slower than their recent average.
    meta:
      dataset: true
      friendly_name: "Spending Pace"
      group: "aggregations"
      semantic:
        measures:
          - name: month_spending_so_far
            expr: "month_spending_so_far"
            agg: max
            description: "Current month spending to date (snapshot)"
          - name: projected_month_total
            expr: "projected_month_total"
            agg: max
            description: "Projected total spending for the month (snapshot)"
          - name: avg_daily_spending
            expr: "avg_daily_spending"
            agg: avg
            description: "Average daily spending rate"
          - name: pace_ratio
            expr: "pace_ratio"
            agg: avg
            description: "Ratio of actual to expected spending"
        dimensions:
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency of the amounts"
          - name: pace_status
            expr: "pace_status"
            type: categorical
            description: "Spending pace status (ahead, on_track, behind, no_history)"
        sample_questions:
          - "Am I on track with my spending this month?"
          - "What is my projected spending for this month?"
          - "What is my average daily spending rate?"
    columns:
      - name: user_id
        description: Owner of the transactions (UUID)
        data_tests:
          - not_null
      - name: currency
        description: Currency of the amounts
        data_tests:
          - not_null
      - name: month_spending_so_far
        description: Total spending in the current month so far
        data_tests:
          - not_null
      - name: days_elapsed
        description: Days elapsed in the current month (including today)
        data_tests:
          - not_null
      - name: days_in_month
        description: Total days in the current month
        data_tests:
          - not_null
      - name: avg_daily_spending
        description: Average daily spending from the last 90 days
        data_tests:
          - not_null
      - name: expected_spending
        description: Expected spending so far based on historical daily average
        data_tests:
          - not_null
      - name: projected_month_total
        description: Projected total spending for the full month
        data_tests:
          - not_null
      - name: pace_ratio
        description: Ratio of actual to expected spending (>1 means spending faster)
      - name: pace_status
        description: Status label (ahead, on_track, behind, no_history)
        data_tests:
          - not_null
          - accepted_values:
              values: ['ahead', 'on_track', 'behind', 'no_history']
      - name: amount_difference
        description: Actual minus expected spending (positive = overspending)
        data_tests:
          - not_null

  - name: fct_budget_vs_actual
    description: |
      Budget vs actual spending comparison for the current period.
      Compares budgets (weekly/monthly/quarterly/annual) against actual spending by tag category.
    meta:
      dataset: true
      friendly_name: "Budget vs Actual"
      group: "budgets"
      filters:
        tag_id_column: "tag_id"
      semantic:
        measures:
          - name: budget_amount
            expr: "budget_amount"
            agg: sum
            description: "Total budget limit"
          - name: spent_amount
            expr: "spent_amount"
            agg: sum
            description: "Total amount spent"
          - name: remaining_amount
            expr: "remaining_amount"
            agg: sum
            description: "Total remaining budget"
          - name: percentage_used
            expr: "percentage_used"
            agg: avg
            description: "Average percentage of budget used"
          - name: transaction_count
            expr: "transaction_count"
            agg: sum
            description: "Total transactions against budgets"
        dimensions:
          - name: tag_name
            expr: "tag_name"
            type: categorical
            description: "Budget tag name"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency code"
          - name: period
            expr: "period"
            type: categorical
            description: "Budget period (weekly, monthly, quarterly, annual)"
          - name: budget_status
            expr: "budget_status"
            type: categorical
            description: "Budget status (ok, warning, exceeded)"
        sample_questions:
          - "Which budgets am I close to exceeding?"
          - "How much budget do I have remaining?"
          - "What percentage of my budgets have I used?"
    columns:
      - name: budget_id
        description: Budget UUID
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the budget (UUID)
        data_tests:
          - not_null
      - name: tag_id
        description: Tag UUID for budget category
        data_tests:
          - not_null
      - name: tag_name
        description: Tag name
        data_tests:
          - not_null
      - name: tag_colour
        description: Tag colour (hex)
      - name: budget_amount
        description: Budget limit
        data_tests:
          - not_null
      - name: currency
        description: Currency code
        data_tests:
          - not_null
      - name: period
        description: Budget period (weekly, monthly, quarterly, annual)
        data_tests:
          - not_null
      - name: warning_threshold
        description: Warning threshold (0.0-1.0)
      - name: spent_amount
        description: Amount spent in current period
        data_tests:
          - not_null
      - name: transaction_count
        description: Number of transactions
        data_tests:
          - not_null
      - name: remaining_amount
        description: Remaining budget
        data_tests:
          - not_null
      - name: days_remaining
        description: Days remaining in current period
        data_tests:
          - not_null
      - name: percentage_used
        description: Percentage of budget used
        data_tests:
          - not_null
      - name: budget_status
        description: Status - ok, warning, or exceeded
        data_tests:
          - not_null
      - name: period_start
        description: Start of budget period
        data_tests:
          - not_null
      - name: period_end
        description: End of budget period
        data_tests:
          - not_null
      - name: period_key
        description: Period key (e.g., 2026-W05, 2026-01, 2026-Q1, 2026)
        data_tests:
          - not_null

  - name: fct_budget_forecast
    description: |
      Budget forecast projecting when budgets will be exceeded.
      Uses historical 90-day spending patterns to project budget exhaustion dates.
    meta:
      dataset: true
      friendly_name: "Budget Forecast"
      group: "budgets"
      filters:
        tag_id_column: "tag_id"
      semantic:
        measures:
          - name: budget_amount
            expr: "budget_amount"
            agg: sum
            description: "Total budget limit"
          - name: spent_amount
            expr: "spent_amount"
            agg: sum
            description: "Total amount spent"
          - name: remaining_amount
            expr: "remaining_amount"
            agg: sum
            description: "Total remaining budget"
          - name: projected_percentage
            expr: "projected_percentage"
            agg: avg
            description: "Average projected percentage used at end of period"
          - name: daily_avg_spending
            expr: "daily_avg_spending"
            agg: avg
            description: "Average daily spending rate"
        dimensions:
          - name: tag_name
            expr: "tag_name"
            type: categorical
            description: "Budget tag name"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency code"
          - name: period
            expr: "period"
            type: categorical
            description: "Budget period (weekly, monthly, quarterly, annual)"
          - name: risk_level
            expr: "risk_level"
            type: categorical
            description: "Forecast risk level (low, medium, high, critical)"
        sample_questions:
          - "Which budgets are at risk of being exceeded?"
          - "What is my projected budget usage by end of period?"
          - "What is my daily average spending by budget?"
    columns:
      - name: budget_id
        description: Budget UUID
        data_tests:
          - not_null
      - name: user_id
        description: Owner of the budget (UUID)
        data_tests:
          - not_null
      - name: tag_id
        description: Tag UUID for budget category
        data_tests:
          - not_null
      - name: tag_name
        description: Tag name
        data_tests:
          - not_null
      - name: tag_colour
        description: Tag colour (hex)
      - name: budget_amount
        description: Budget limit
        data_tests:
          - not_null
      - name: currency
        description: Currency code
        data_tests:
          - not_null
      - name: period
        description: Budget period (weekly, monthly, quarterly, annual)
        data_tests:
          - not_null
      - name: spent_amount
        description: Amount spent in current period
        data_tests:
          - not_null
      - name: remaining_amount
        description: Remaining budget
        data_tests:
          - not_null
      - name: percentage_used
        description: Percentage of budget used
        data_tests:
          - not_null
      - name: budget_status
        description: Status - ok, warning, or exceeded
        data_tests:
          - not_null
      - name: daily_avg_spending
        description: Historical daily average spending (last 90 days)
        data_tests:
          - not_null
      - name: days_until_exhausted
        description: Projected days until budget is exhausted (null if no spending history)
      - name: projected_exceed_date
        description: Date when budget is projected to be exceeded
      - name: will_exceed_in_period
        description: Whether budget will exceed before period ends
        data_tests:
          - not_null
      - name: projected_percentage
        description: Projected percentage used at end of period
        data_tests:
          - not_null
      - name: risk_level
        description: Risk level (low, medium, high, critical)
        data_tests:
          - not_null

  - name: fct_goal_progress
    description: |
      Savings goal progress tracking.
      Includes calculated metrics for progress, remaining amount, and deadline tracking.
    meta:
      dataset: true
      friendly_name: "Goal Progress"
      group: "goals"
      semantic:
        measures:
          - name: target_amount
            expr: "target_amount"
            agg: sum
            description: "Total target savings amount"
          - name: current_amount
            expr: "current_amount"
            agg: sum
            description: "Total current saved amount"
          - name: remaining_amount
            expr: "remaining_amount"
            agg: sum
            description: "Total remaining to reach targets"
          - name: progress_percentage
            expr: "progress_percentage"
            agg: avg
            description: "Average progress percentage"
        dimensions:
          - name: goal_name
            expr: "goal_name"
            type: categorical
            description: "Goal name"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency code"
          - name: status
            expr: "status"
            type: categorical
            description: "Goal status (active, paused, completed, cancelled)"
        sample_questions:
          - "How close am I to my savings goals?"
          - "Which goals are on track?"
          - "How much more do I need to save across all goals?"
    columns:
      - name: goal_id
        description: Goal UUID
        data_tests:
          - not_null
          - unique
      - name: user_id
        description: Owner of the goal (UUID)
        data_tests:
          - not_null
      - name: goal_name
        description: Goal name
        data_tests:
          - not_null
      - name: target_amount
        description: Target savings amount
        data_tests:
          - not_null
      - name: current_amount
        description: Current saved amount (from manual entry or linked account)
        data_tests:
          - not_null
      - name: currency
        description: Currency code
        data_tests:
          - not_null
      - name: deadline
        description: Target deadline
      - name: account_id
        description: Linked account UUID (if auto-tracking)
      - name: account_name
        description: Linked account name
      - name: status
        description: Goal status (active, paused, completed, cancelled)
        data_tests:
          - not_null
      - name: notes
        description: User notes
      - name: progress_percentage
        description: Progress percentage (0-100)
        data_tests:
          - not_null
      - name: remaining_amount
        description: Amount remaining to reach target
        data_tests:
          - not_null
      - name: days_remaining
        description: Days until deadline (null if no deadline)
      - name: is_overdue
        description: Whether goal is past deadline
      - name: is_on_track
        description: Whether current progress rate will reach target by deadline
      - name: created_at
        description: When goal was created
        data_tests:
          - not_null
      - name: updated_at
        description: When goal was last updated
        data_tests:
          - not_null

  - name: fct_cash_flow_forecast
    description: |
      Cash flow forecast projecting future balances.
      Combines recurring patterns (detected and confirmed) with planned transactions
      to project balance changes over the next 90 days.
    meta:
      dataset: true
      friendly_name: "Cash Flow Forecast"
      group: "forecasting"
      time_grain: "day"
      filters:
        date_column: "forecast_date"
      semantic:
        measures:
          - name: daily_change
            expr: "daily_change"
            agg: sum
            description: "Total net cash flow"
          - name: daily_income
            expr: "daily_income"
            agg: sum
            description: "Total expected income"
          - name: daily_expenses
            expr: "daily_expenses"
            agg: sum
            description: "Total expected expenses"
          - name: projected_balance
            expr: "projected_balance"
            agg: max
            description: "Projected balance (latest snapshot)"
          - name: event_count
            expr: "event_count"
            agg: sum
            description: "Total number of cash flow events"
        dimensions:
          - name: forecast_date
            expr: "forecast_date"
            type: time
            description: "Date of the forecast"
          - name: currency
            expr: "currency"
            type: categorical
            description: "Currency of the amounts"
        sample_questions:
          - "What is my projected balance in 30 days?"
          - "What upcoming expenses do I have?"
          - "What is my expected cash flow this month?"
    columns:
      - name: user_id
        description: Owner of the forecast (UUID)
        data_tests:
          - not_null
      - name: forecast_date
        description: Date of the forecast
        data_tests:
          - not_null
      - name: currency
        description: Currency of the amounts
        data_tests:
          - not_null
      - name: starting_balance
        description: Net worth at forecast start date
        data_tests:
          - not_null
      - name: as_of_date
        description: Date of the starting balance snapshot
        data_tests:
          - not_null
      - name: daily_change
        description: Net cash flow for this day (income - expenses)
        data_tests:
          - not_null
      - name: daily_income
        description: Total income expected on this day
        data_tests:
          - not_null
      - name: daily_expenses
        description: Total expenses expected on this day
        data_tests:
          - not_null
      - name: event_count
        description: Number of cash flow events on this day
        data_tests:
          - not_null
      - name: cumulative_change
        description: Cumulative net change from forecast start
        data_tests:
          - not_null
      - name: projected_balance
        description: Projected balance (starting + cumulative change)
        data_tests:
          - not_null
      - name: days_from_now
        description: Days from today
      - name: forecast_week
        description: Week number in forecast (1-based)
